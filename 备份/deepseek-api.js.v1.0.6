/**
 * DeepSeek API æ¥å£
 * ç”¨äºå¤„ç†ä¸DeepSeek AIçš„é€šä¿¡
 * ç‰ˆæœ¬: 1.0.0
 */

class DeepSeekAPI {
    constructor(apiKey = null) {
        // é¢„è®¾APIå¯†é’¥ï¼Œå¦‚æœæ²¡æœ‰æä¾›åˆ™ä½¿ç”¨é»˜è®¤å€¼
        this.apiKey = apiKey || 'sk-e14ca5937bec444da5bd8bf0aa59f4fe';
        
        // APIé…ç½®
        this.baseURL = 'https://api.deepseek.ai';
        this.apiVersion = 'v1';
        this.apiEndpoint = '/chat/completions';
        
        // æ¨¡å‹é…ç½®
        this.availableModels = {
            default: 'deepseek-llm-67b-chat',
            alternatives: [
                'deepseek-chat',
                'deepseek-coder',
                'deepseek-coder-instruct-6.7b',
                'deepseek-coder-6.7b-instruct',
                'deepseek-llm-7b-chat'
            ]
        };
        
        // é»˜è®¤ä½¿ç”¨ç¬¬ä¸€ä¸ªæ¨¡å‹
        this.currentModel = this.availableModels.default;
        
        // å…¶ä»–è®¾ç½®
        this.systemPrompt = this.getDefaultSystemPrompt();
        this.conversationHistory = [];
        this.isThinking = false;
        
        // æ¨¡æ‹Ÿæ¨¡å¼è®¾ç½® - å¼€å‘æ—¶å¯ä»¥å¼€å¯ï¼Œç”Ÿäº§ç¯å¢ƒå¿…é¡»å…³é—­
        this.simulationMode = false;
        
        // ä¿å­˜é»˜è®¤APIå¯†é’¥åˆ°æœ¬åœ°å­˜å‚¨
        if (!localStorage.getItem('deepseek_api_key')) {
            localStorage.setItem('deepseek_api_key', this.apiKey);
        }
        
        // ä»æœ¬åœ°å­˜å‚¨åŠ è½½æ¨¡æ‹Ÿæ¨¡å¼è®¾ç½®
        const savedSimMode = localStorage.getItem('deepseek_simulation_mode');
        if (savedSimMode !== null) {
            this.simulationMode = savedSimMode === 'true';
        }
        
        console.log(`DeepSeek API åˆå§‹åŒ–å®Œæˆï¼Œæ¨¡æ‹Ÿæ¨¡å¼: ${this.simulationMode ? 'å¼€å¯' : 'å…³é—­'}`);
    }

    /**
     * è®¾ç½®APIå¯†é’¥
     * @param {string} apiKey - DeepSeek APIå¯†é’¥
     */
    setApiKey(apiKey) {
        this.apiKey = apiKey;
        // ä¿å­˜åˆ°æœ¬åœ°å­˜å‚¨ï¼Œæ–¹ä¾¿ä¸‹æ¬¡ä½¿ç”¨
        localStorage.setItem('deepseek_api_key', apiKey);
        return this;
    }

    /**
     * è·å–APIå¯†é’¥
     * @returns {string|null} APIå¯†é’¥
     */
    getApiKey() {
        // å¦‚æœå†…å­˜ä¸­æ²¡æœ‰ï¼Œå°è¯•ä»æœ¬åœ°å­˜å‚¨è·å–
        if (!this.apiKey) {
            this.apiKey = localStorage.getItem('deepseek_api_key');
        }
        return this.apiKey;
    }

    /**
     * è®¾ç½®ä½¿ç”¨çš„æ¨¡å‹
     * @param {string} model - æ¨¡å‹åç§°
     */
    setModel(model) {
        this.model = model;
        return this;
    }

    /**
     * è®¾ç½®ç³»ç»Ÿæç¤ºè¯
     * @param {string} prompt - ç³»ç»Ÿæç¤ºè¯
     */
    setSystemPrompt(prompt) {
        this.systemPrompt = prompt;
        return this;
    }

    /**
     * è·å–é»˜è®¤çš„ç³»ç»Ÿæç¤ºè¯
     * @returns {string} é»˜è®¤ç³»ç»Ÿæç¤ºè¯
     */
    getDefaultSystemPrompt() {
        return `ä½ æ˜¯ä¸€ä¸ªä¸ªäººå·¥ä½œåŠ©æ‰‹AIï¼Œå¸®åŠ©ç”¨æˆ·ç®¡ç†ä»–ä»¬çš„é¡¹ç›®ã€éœ€æ±‚å’Œä»»åŠ¡ã€‚
ä½ å¯ä»¥å›ç­”å…³äºé¡¹ç›®è¿›åº¦ã€ä»»åŠ¡çŠ¶æ€ã€å›¢é˜Ÿæˆå‘˜å·¥ä½œåˆ†é…ç­‰é—®é¢˜ã€‚
å½“ç”¨æˆ·è¯¢é—®ç‰¹å®šé¡¹ç›®ã€éœ€æ±‚æˆ–ä»»åŠ¡æ—¶ï¼Œä½ åº”è¯¥æä¾›è¯¦ç»†ä¿¡æ¯ã€‚
å¦‚æœç”¨æˆ·è¯¢é—®"æˆ‘æœ‰å“ªäº›æœªå®Œæˆçš„ä»»åŠ¡"ï¼Œä½ åº”è¯¥åˆ—å‡ºæ‰€æœ‰æœªå®Œæˆçš„ä»»åŠ¡ã€‚
å¦‚æœç”¨æˆ·è¯¢é—®"é¡¹ç›®Xçš„è¿›åº¦å¦‚ä½•"ï¼Œä½ åº”è¯¥æä¾›è¯¥é¡¹ç›®çš„å½“å‰è¿›åº¦å’ŒçŠ¶æ€ã€‚
å¦‚æœç”¨æˆ·è¯¢é—®"è°è´Ÿè´£ä»»åŠ¡Y"ï¼Œä½ åº”è¯¥å‘Šè¯‰ç”¨æˆ·è´Ÿè´£è¯¥ä»»åŠ¡çš„å›¢é˜Ÿæˆå‘˜ã€‚
è¯·ä½¿ç”¨ç®€æ´ã€ä¸“ä¸šçš„è¯­è¨€å›ç­”é—®é¢˜ï¼Œå¹¶åœ¨é€‚å½“çš„æ—¶å€™æä¾›å¯è§†åŒ–æ•°æ®ã€‚`;
    }

    /**
     * å‘é€æ¶ˆæ¯åˆ°DeepSeek API
     * @param {string} message - ç”¨æˆ·æ¶ˆæ¯
     * @param {function} onThinking - æ€è€ƒçŠ¶æ€å›è°ƒ
     * @param {function} onResponse - å“åº”å›è°ƒ
     * @param {function} onError - é”™è¯¯å›è°ƒ
     */
    async sendMessage(message, onThinking = null, onResponse = null, onError = null) {
        // æ›´æ–°æ€è€ƒçŠ¶æ€
        this.isThinking = true;
        if (onThinking) onThinking(true);
        
        // æ·»åŠ ç”¨æˆ·æ¶ˆæ¯åˆ°å†å²
        this.conversationHistory.push({
            role: 'user',
            content: message
        });
        
        console.log('å‘é€æ¶ˆæ¯åˆ°DeepSeek API:', message);
        console.log('å½“å‰æ¨¡æ‹Ÿæ¨¡å¼çŠ¶æ€:', this.simulationMode ? 'å¼€å¯' : 'å…³é—­');
        
        try {
            // å¦‚æœåœ¨æ¨¡æ‹Ÿæ¨¡å¼ä¸‹ï¼Œä½¿ç”¨æ¨¡æ‹Ÿæ•°æ®
            if (this.simulationMode) {
                console.log('ä½¿ç”¨æ¨¡æ‹ŸDeepSeekå“åº”');
                await this.simulateApiResponse(message, onResponse);
                return;
            }
            
            // å¦åˆ™ä½¿ç”¨çœŸå®API
            console.log('ä½¿ç”¨çœŸå®DeepSeek API');
            
            // å‡†å¤‡è¯·æ±‚æ•°æ®
            const requestData = {
                model: this.currentModel,
                messages: [
                    {
                        role: 'system',
                        content: this.systemPrompt
                    },
                    ...this.conversationHistory
                ],
                temperature: 0.7,
                max_tokens: 2000
            };
            
            console.log('è¯·æ±‚æ•°æ®:', JSON.stringify(requestData, null, 2));
            
            // æ„å»ºAPI URL
            const apiUrl = `${this.baseURL}/${this.apiVersion}${this.apiEndpoint}`;
            console.log('è¯·æ±‚URL:', apiUrl);
            
            try {
                // å‘é€APIè¯·æ±‚
                const response = await fetch(apiUrl, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${this.apiKey}`
                    },
                    body: JSON.stringify(requestData)
                });
                
                // æ£€æŸ¥å“åº”çŠ¶æ€
                if (!response.ok) {
                    const errorText = await response.text();
                    console.error(`APIå“åº”é”™è¯¯ (${response.status})`, errorText);
                    
                    // å¦‚æœæ˜¯æ¨¡å‹é”™è¯¯ï¼Œå°è¯•å¤‡ç”¨æ¨¡å‹
                    if (response.status === 404 || errorText.includes('model')) {
                        // å°è¯•å¤‡ç”¨æ¨¡å‹
                        return await this.retryWithAlternativeModel(message, onThinking, onResponse, onError);
                    }
                    
                    throw new Error(`APIå“åº”é”™è¯¯ (${response.status}): ${errorText}`);
                }
                
                // è§£æå“åº”
                const data = await response.json();
                console.log('DeepSeek APIå“åº”:', data);
                
                // å¤„ç†æœ‰æ•ˆå“åº”
                if (data && data.choices && data.choices.length > 0) {
                    const aiResponse = data.choices[0].message.content;
                    
                    // æ·»åŠ AIå›å¤åˆ°å†å²
                    this.conversationHistory.push({
                        role: 'assistant',
                        content: aiResponse
                    });
                    
                    // è°ƒç”¨å“åº”å›è°ƒ
                    if (onResponse) onResponse(aiResponse);
                } else {
                    throw new Error('APIå“åº”æ ¼å¼ä¸æ­£ç¡®');
                }
            } catch (apiError) {
                console.error('DeepSeek APIè°ƒç”¨å¤±è´¥:', apiError);
                
                // å¦‚æœæ˜¯ç½‘ç»œé”™è¯¯ï¼Œå°è¯•å¤‡ç”¨æ¨¡å‹
                if (apiError.message.includes('Failed to fetch') || apiError.message.includes('Network')) {
                    // å°è¯•å¤‡ç”¨æ¨¡å‹
                    return await this.retryWithAlternativeModel(message, onThinking, onResponse, onError);
                }
                
                // è¿”å›é”™è¯¯ä¿¡æ¯
                if (onError) onError(`DeepSeek APIè°ƒç”¨å¤±è´¥: ${apiError.message}`);
                
                // åœ¨ç”Ÿäº§ç¯å¢ƒä¸‹å¦‚æœAPIè°ƒç”¨å¤±è´¥ï¼Œåˆ™åˆ‡æ¢åˆ°æ¨¡æ‹Ÿæ¨¡å¼
                console.log('åˆ‡æ¢åˆ°æ¨¡æ‹Ÿæ¨¡å¼ä»¥æä¾›åº”æ€¥å“åº”');
                this.simulationMode = true;
                localStorage.setItem('deepseek_simulation_mode', 'true');
                await this.simulateApiResponse(message, onResponse);
            }
        } catch (error) {
            console.error('DeepSeek APIé”™è¯¯:', error);
            if (onError) onError(`APIè¯·æ±‚å¤±è´¥: ${error.message}`);
        } finally {
            // æ›´æ–°æ€è€ƒçŠ¶æ€
            this.isThinking = false;
            if (onThinking) onThinking(false);
        }
    }
    
    /**
     * ä½¿ç”¨å¤‡ç”¨æ¨¡å‹é‡è¯•
     */
    async retryWithAlternativeModel(message, onThinking, onResponse, onError) {
        console.log('å°è¯•ä½¿ç”¨å¤‡ç”¨æ¨¡å‹é‡è¯•...');
        
        // å°è¯•æ¯ä¸ªå¤‡ç”¨æ¨¡å‹
        for (const model of this.availableModels.alternatives) {
            if (model === this.currentModel) continue; // è·³è¿‡å½“å‰æ¨¡å‹
            
            console.log(`å°è¯•æ¨¡å‹: ${model}`);
            this.currentModel = model;
            
            try {
                // é‡æ–°è°ƒç”¨sendMessageï¼Œä½†ä¸ä¼ é€’å›è°ƒä»¥é¿å…é‡å¤å›è°ƒ
                await this.sendMessage(message, onThinking, onResponse, null);
                console.log(`æ¨¡å‹ ${model} æˆåŠŸï¼`);
                return; // æˆåŠŸåˆ™è¿”å›
            } catch (retryError) {
                console.error(`æ¨¡å‹ ${model} å¤±è´¥:`, retryError);
                // ç»§ç»­å°è¯•ä¸‹ä¸€ä¸ªæ¨¡å‹
            }
        }
        
        // æ‰€æœ‰æ¨¡å‹éƒ½å¤±è´¥ï¼Œè¿”å›é”™è¯¯
        console.log('æ‰€æœ‰æ¨¡å‹éƒ½å¤±è´¥ï¼Œåˆ‡æ¢åˆ°æ¨¡æ‹Ÿæ¨¡å¼');
        this.simulationMode = true;
        localStorage.setItem('deepseek_simulation_mode', 'true');
        
        // ä½¿ç”¨æ¨¡æ‹Ÿæ•°æ®
        await this.simulateApiResponse(message, onResponse);
        
        if (onError) onError('æ‰€æœ‰DeepSeekæ¨¡å‹è°ƒç”¨å¤±è´¥ï¼Œå·²åˆ‡æ¢åˆ°æ¨¡æ‹Ÿæ¨¡å¼');
    }

    /**
     * æ¨¡æ‹ŸAPIå“åº”ï¼ˆå¼€å‘é˜¶æ®µä½¿ç”¨ï¼‰
     * @param {string} message - ç”¨æˆ·æ¶ˆæ¯
     * @param {function} onResponse - å“åº”å›è°ƒ
     */
    async simulateApiResponse(message, onResponse) {
        // æ¨¡æ‹Ÿç½‘ç»œå»¶è¿Ÿ
        await new Promise(resolve => setTimeout(resolve, 1000 + Math.random() * 2000));
        
        // æ¨¡æ‹ŸAIå›å¤
        let aiResponse = '';
        
        // æ ¹æ®ç”¨æˆ·æ¶ˆæ¯ç”Ÿæˆæ¨¡æ‹Ÿå›å¤
        if (message.includes('æœªå®Œæˆ') || message.includes('å¾…åŠ')) {
            aiResponse = `æ‚¨ç›®å‰æœ‰ä»¥ä¸‹æœªå®Œæˆçš„ä»»åŠ¡ï¼š
1. ã€é«˜ä¼˜å…ˆçº§ã€‘UIè®¾è®¡è¯„å®¡ - æˆªæ­¢æ—¶é—´ï¼šä»Šå¤©18:00
2. ã€ä¸­ä¼˜å…ˆçº§ã€‘å‰ç«¯æ¡†æ¶é€‰å‹ - æˆªæ­¢æ—¶é—´ï¼šæ˜å¤©10:00
3. ã€ä¸­ä¼˜å…ˆçº§ã€‘éœ€æ±‚æ–‡æ¡£å®šç¨¿ - æˆªæ­¢æ—¶é—´ï¼šåå¤©15:00
4. ã€ä½ä¼˜å…ˆçº§ã€‘å›¢é˜Ÿå‘¨ä¼šå‡†å¤‡ - æˆªæ­¢æ—¶é—´ï¼šå‘¨äº”14:00

æ‚¨è¿˜æœ‰2ä¸ªé¡¹ç›®çš„5ä¸ªéœ€æ±‚å°šæœªå®Œæˆã€‚éœ€è¦æˆ‘åˆ—å‡ºè¯¦ç»†ä¿¡æ¯å—ï¼Ÿ`;
        } 
        else if (message.includes('é¡¹ç›®') && (message.includes('è¿›åº¦') || message.includes('è¿›å±•'))) {
            aiResponse = `å·¥ä½œåŠ©æ‰‹é¡¹ç›®å½“å‰è¿›åº¦ä¸º65%ã€‚

å·²å®Œæˆçš„é‡Œç¨‹ç¢‘ï¼š
âœ… éœ€æ±‚åˆ†æ
âœ… åŸå‹è®¾è®¡
âœ… å‰ç«¯æ¡†æ¶æ­å»º

è¿›è¡Œä¸­çš„ä»»åŠ¡ï¼š
ğŸ”„ DeepSeek APIé›†æˆ (80%)
ğŸ”„ æ•°æ®æ¨¡å‹è®¾è®¡ (50%)
ğŸ”„ ä»ªè¡¨ç›˜å¼€å‘ (30%)

ä¸‹ä¸€æ­¥è®¡åˆ’ï¼š
ğŸ“Œ å®ŒæˆDeepSeeké›†æˆ
ğŸ“Œ å®ç°æœ¬åœ°æ•°æ®å­˜å‚¨
ğŸ“Œ å¼€å‘é¡¹ç›®ç®¡ç†æ¨¡å—

é¡¹ç›®é¢„è®¡åœ¨6æœˆ15æ—¥å‰å®Œæˆç¬¬ä¸€ä¸ªå¯ç”¨ç‰ˆæœ¬ã€‚`;
        }
        else if (message.includes('è´Ÿè´£') || message.includes('è°')) {
            aiResponse = `å½“å‰ä»»åŠ¡è´Ÿè´£äººåˆ†é…å¦‚ä¸‹ï¼š

1. DeepSeek APIé›†æˆ - è´Ÿè´£äººï¼šå¼ ä¸‰
2. æ•°æ®æ¨¡å‹è®¾è®¡ - è´Ÿè´£äººï¼šæå››
3. å‰ç«¯ç•Œé¢å¼€å‘ - è´Ÿè´£äººï¼šç‹äº”
4. æµ‹è¯•ä¸éƒ¨ç½² - è´Ÿè´£äººï¼šèµµå…­

å¼ ä¸‰ç›®å‰è´Ÿè´£çš„ä»»åŠ¡æœ€å¤šï¼Œå…±æœ‰3ä¸ªè¿›è¡Œä¸­çš„ä»»åŠ¡ã€‚
æå››çš„å·¥ä½œè´Ÿè½½æœ€ä½ï¼Œå¯ä»¥è€ƒè™‘åˆ†é…æ–°ä»»åŠ¡ç»™ä»–ã€‚`;
        }
        else if (message.includes('æˆªæ­¢') || message.includes('æ—¥æœŸ')) {
            aiResponse = `è¿‘æœŸæˆªæ­¢çš„é‡è¦äº‹é¡¹ï¼š

ä»Šå¤© (5æœˆ30æ—¥)ï¼š
- UIè®¾è®¡è¯„å®¡ (18:00)
- å®¢æˆ·éœ€æ±‚ç¡®è®¤ (22:00)

æ˜å¤© (5æœˆ31æ—¥)ï¼š
- å‰ç«¯æ¡†æ¶é€‰å‹ (10:00)
- å‘¨æŠ¥æäº¤ (18:00)

åå¤© (6æœˆ1æ—¥)ï¼š
- éœ€æ±‚æ–‡æ¡£å®šç¨¿ (15:00)

ä¸‹å‘¨ï¼š
- é¡¹ç›®å¯åŠ¨ä¼š (6æœˆ3æ—¥ 10:00)
- ç¬¬ä¸€è½®æµ‹è¯• (6æœˆ5æ—¥ å…¨å¤©)`;
        }
        else {
            aiResponse = `æ‚¨å¥½ï¼Œæˆ‘æ˜¯æ‚¨çš„å·¥ä½œåŠ©æ‰‹ã€‚æˆ‘å¯ä»¥å¸®æ‚¨ï¼š

1. æŸ¥è¯¢é¡¹ç›®ã€éœ€æ±‚å’Œä»»åŠ¡çš„çŠ¶æ€
2. äº†è§£å›¢é˜Ÿæˆå‘˜çš„å·¥ä½œåˆ†é…
3. æŸ¥çœ‹æˆªæ­¢æ—¥æœŸå’Œé‡è¦äº‹é¡¹
4. è·å–é¡¹ç›®è¿›åº¦æŠ¥å‘Š

è¯·å‘Šè¯‰æˆ‘æ‚¨éœ€è¦äº†è§£ä»€ä¹ˆä¿¡æ¯ï¼Ÿ`;
        }
        
        // æ·»åŠ AIå›å¤åˆ°å†å²
        this.conversationHistory.push({
            role: 'assistant',
            content: aiResponse
        });
        
        if (onResponse) onResponse(aiResponse);
    }

    /**
     * æ¸…é™¤å¯¹è¯å†å²
     */
    clearHistory() {
        this.conversationHistory = [];
        return this;
    }

    /**
     * è·å–å¯¹è¯å†å²
     * @returns {Array} å¯¹è¯å†å²
     */
    getHistory() {
        return this.conversationHistory;
    }

    /**
     * ä¿å­˜å¯¹è¯å†å²åˆ°æœ¬åœ°å­˜å‚¨
     */
    saveHistory() {
        localStorage.setItem('deepseek_conversation', JSON.stringify(this.conversationHistory));
        return this;
    }

    /**
     * ä»æœ¬åœ°å­˜å‚¨åŠ è½½å¯¹è¯å†å²
     */
    loadHistory() {
        const saved = localStorage.getItem('deepseek_conversation');
        if (saved) {
            try {
                this.conversationHistory = JSON.parse(saved);
            } catch (e) {
                console.error('åŠ è½½å¯¹è¯å†å²å¤±è´¥:', e);
                this.conversationHistory = [];
            }
        }
        return this;
    }
}

// å¯¼å‡ºDeepSeekAPIç±»
window.DeepSeekAPI = DeepSeekAPI;
